---
- name: Create database for Dashboard
  mysql_db: name={{ dashboard_db.name }} state=present config_file=/etc/mysql/debian.cnf
  register: db

- name: Initialize database
  mysql_db:
    state: import
    name: "{{ dashboard_db.name }}"
    target: "{{ dashboard_path }}/scripts/mysql.sql"
    config_file: /etc/mysql/debian.cnf
  when: db.changed

- name: Create database user for Dashboard
  mysql_user:
    name: "{{ dashboard_db.username }}"
    password: "{{ dashboard_db.password }}"
    priv: "{{ dashboard_db.name }}.*:ALL"
    state: present
    config_file: /etc/mysql/debian.cnf

- name: Generate createAdminUser script
  template: src=createAdminUser.php dest={{ dashboard_path }}/scripts/
  when: db.changed

- name: Create first user!
  shell: php createAdminUser.php
  args:
    chdir: "{{ dashboard_path }}/scripts"
  when: db.changed

- name: Delete createAdminUser script
  file:
    path: "{{ dashboard_path }}/scripts/createAdminUser.php"
    state: absent
