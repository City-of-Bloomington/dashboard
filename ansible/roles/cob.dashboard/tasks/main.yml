---
# Sets up a development version of dashboard
#
# A production task list might look very different, since
# it would be pulling from the release version.
# Releases that we make available will already be built, so,
# there would be no need for many the dependencies needed to build.
- name: Install Development Dependencies
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - gettext
    - nodejs
    - npm

- name: Update symlinks to node
  file: state=link src=/usr/bin/nodejs path=/usr/bin/node

- name: Update npm
  command: "npm install npm@latest -g"

- name: Update node-sass
  command: "npm install node-sass@latest -g"

- file: path='{{ dashboard_path }}' state=directory mode=2755

- name: Check out source repository with git
  git:
    repo: https://github.com/City-of-Bloomington/dashboard.git
    dest: "{{ dashboard_path }}"
    update: no
  notify: dashbo update permissions

- name: check if dashboard apache config already exists
  stat: path={{ dashboard_apache_config }}
  register: original

# check if backup of dashboard_apache_config exists
# if it already exists, we won't move it again
- name: check if dashboard apached config backup already exists
  stat: path={{ dashboard_apache_config }}.bkup
  register: backup

#note that "copy" command in ansible copies from ansible client to host
#one machine to the other
#here we just want to do the copy only on the host
- name: Make a backup copy of dashboard apache config file
  shell: cp {{ dashboard_apache_config }} {{ dashboard_apache_config }}.bkup
  when: original.stat.exists and not backup.stat.exists

- name: Create an apache config file for dashboard site based on template
  template: src=dashboard.conf dest={{ dashboard_apache_config }}
  notify:
    - restart apache
  tags: dashboard

- name: a2ensite dashboard
  command: a2ensite dashboard
  notify:
    - restart apache

- name: Run the build script
  shell: ./build.sh
  args:
    chdir: "{{ dashboard_path }}"
  notify: dashboard update permissions

- name: configure dashboard application
  template: src=site_config.inc dest={{ dashboard_path }}/data/
  tags: dashboard

- name: configure COB Theme
  template: src=theme_config.inc dest={{ dashboard_path }}/data/Themes/COB
  tags: dashboard

- name: Create database for Dashboard
  mysql_db: name={{ dashboard_db.name }} state=present config_file=/etc/mysql/debian.cnf
  register: db

- name: Initialize database
  mysql_db:
    state: import
    name: "{{ dashboard_db.name }}"
    target: "{{ dashboard_path }}/scripts/mysql.sql"
    config_file: /etc/mysql/debian.cnf
  when: db.changed

- name: Create database user for Dashboard
  mysql_user:
    name: "{{ dashboard_db.username }}"
    password: "{{ dashboard_db.password }}"
    priv: "{{ dashboard_db.name }}.*:ALL"
    state: present
    config_file: /etc/mysql/debian.cnf

- name: update createPerson script
  template: src=createPerson.php dest={{ dashboard_path }}/scripts/
  tags: dashboard

- name: Create first user!
  shell: php createPerson.php
  args:
    chdir: "{{ dashboard_path }}/scripts"
  when: db.changed
